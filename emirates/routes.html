<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emirates PTFS Route Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --ek-red: #D71921;
            --ek-red-dark: #b01419;
            --ek-gold: #C6A87C;
            --ek-gold-light: #e0c8a0;
            --ek-dark: #333333;
            --ek-light: #f9f9f9;
            --ek-gray: #666666;
            --shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            overflow: hidden;
            background: var(--ek-light);
            color: var(--ek-dark);
        }

        /* --- Header --- */
        .header {
            background: white;
            height: 70px;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 1000;
            position: relative;
            border-bottom: 3px solid var(--ek-red);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-img {
            height: 45px;
            width: auto;
        }

        .app-title {
            font-size: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--ek-gray);
            border-left: 1px solid #ddd;
            padding-left: 15px;
            margin-left: 15px;
            font-weight: 600;
        }

        /* --- Layout --- */
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
            position: relative;
        }

        #map {
            flex: 1;
            background: #a8d5e2;
            z-index: 1;
        }

        .sidebar {
            width: 400px;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            z-index: 2;
        }

        /* --- Sidebar Components --- */
        .sidebar-header {
            padding: 25px 25px 15px 25px;
            background: #fff;
        }

        .sidebar-title {
            font-family: 'Georgia', serif;
            font-size: 24px;
            color: var(--ek-dark);
            margin-bottom: 5px;
        }

        .sidebar-subtitle {
            font-size: 13px;
            color: var(--ek-gray);
            font-weight: 400;
        }

        /* --- Itinerary Builder --- */
        .booking-widget {
            padding: 0 25px 25px 25px;
            background: #fff;
            border-bottom: 1px solid #eee;
        }

        .itinerary-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .itinerary-segment {
            display: flex;
            align-items: center;
            background: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 10px;
            position: relative;
            transition: all 0.2s;
        }
        
        .itinerary-segment.active {
            border-color: var(--ek-gold);
            background: #fffbf5;
        }

        .segment-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .segment-dot.origin { background: var(--ek-red); }
        .segment-dot.stop { background: var(--ek-gold); }
        .segment-dot.dest { background: var(--ek-dark); }

        .segment-content {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }
        
        .segment-code {
            font-weight: 700;
            color: var(--ek-red);
            margin-right: 5px;
        }

        .segment-remove {
            color: #ccc;
            cursor: pointer;
            padding: 5px;
        }
        .segment-remove:hover { color: var(--ek-red); }

        .dashed-connector {
            position: absolute;
            left: 14px;
            top: 25px;
            height: 25px;
            border-left: 2px dashed #eee;
            z-index: 0;
        }
        .itinerary-segment:last-child .dashed-connector { display: none; }

        .add-flight-placeholder {
            padding: 12px;
            border: 1px dashed #ccc;
            border-radius: 6px;
            text-align: center;
            color: #888;
            font-size: 13px;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .add-flight-placeholder:hover {
            border-color: var(--ek-gold);
            color: var(--ek-gold-dark);
            background: #fffbf5;
        }

        .route-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .btn-text {
            background: none;
            border: none;
            color: var(--ek-gray);
            font-size: 12px;
            cursor: pointer;
            text-decoration: underline;
        }
        .btn-text:hover { color: var(--ek-red); }


        /* --- Flight Details Card --- */
        .flight-card {
            margin: 20px 25px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #eee;
            overflow: hidden;
            display: none;
        }

        .card-header {
            background: linear-gradient(135deg, var(--ek-red) 0%, var(--ek-red-dark) 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
        }

        .card-body { padding: 15px; }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-label { font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 2px; }
        .stat-value { font-size: 14px; font-weight: 600; color: var(--ek-dark); }

        .amenities { display: flex; gap: 5px; flex-wrap: wrap; }
        .amenity-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: #f5f5f5; color: #666; border: 1px solid #eee; }

        /* --- List & Search --- */
        .destinations-wrapper {
            flex: 1;
            overflow-y: hidden;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .search-container {
            padding: 15px 25px;
            border-bottom: 1px solid #f5f5f5;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            padding-left: 35px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 13px;
            outline: none;
            background: #f9f9f9;
        }
        
        .search-input:focus {
            border-color: var(--ek-gold);
            background: white;
        }

        .search-icon {
            position: absolute;
            left: 38px;
            top: 26px; /* Adjust based on padding */
            color: #aaa;
            font-size: 12px;
        }

        .list-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 0 25px 25px 25px;
        }

        .list-header {
            font-size: 11px;
            font-weight: 700;
            color: var(--ek-gray);
            margin: 15px 0 10px 0;
            display: flex;
            justify-content: space-between;
        }

        .destination-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid #f9f9f9;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 6px;
        }

        .destination-item:hover {
            background: #fffcf5;
            padding-left: 16px;
        }
        
        .destination-item.selected {
            background: #f0f0f0;
            opacity: 0.6;
        }

        .destination-code {
            font-weight: 700;
            font-size: 13px;
            width: 40px;
            color: var(--ek-red);
        }

        .destination-details { flex: 1; }
        .destination-name { font-size: 13px; color: var(--ek-dark); font-weight: 500; }
        .destination-country { font-size: 11px; color: #999; }

        /* --- Map Markers & Clusters --- */
        .custom-marker { transition: all 0.3s ease; }
        
        /* City Marker */
        .marker-pin {
            width: 14px;
            height: 14px;
            background: var(--ek-red);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* Selected Route Marker (No Cluster) */
        .marker-selected {
            width: 18px;
            height: 18px;
            background: var(--ek-dark);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 3px 8px rgba(0,0,0,0.5);
            z-index: 1000 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
            font-weight: bold;
        }
        
        .marker-selected.origin { background: var(--ek-red); }
        .marker-selected.stop { background: var(--ek-gold); }

        /* Hub Marker */
        .marker-hub {
            width: 20px;
            height: 20px;
            background: var(--ek-gold);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .marker-hub i { color: white; font-size: 10px; }

        /* Custom Cluster */
        .ek-cluster {
            background: rgba(215, 25, 33, 0.1);
            border-radius: 50%;
        }
        .ek-cluster div {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--ek-red) 0%, var(--ek-red-dark) 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            margin-left: 2px;
            margin-top: 2px;
        }
        .ek-cluster-large div {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--ek-gold) 0%, #b09060 100%);
            font-size: 16px;
        }

        .ek-tooltip {
            background: var(--ek-dark);
            border: none;
            color: white;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .ek-tooltip::before { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo-container">
            <img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/Emirates_logo.svg" alt="Emirates" class="logo-img">
            <div class="app-title">Route Map</div>
        </div>
        <div style="font-size: 12px; font-weight: 600; color: var(--ek-red);">
            <i class="fas fa-globe-asia"></i> GLOBAL NETWORK
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">Flight Planner</h1>
                <p class="sidebar-subtitle">Build your multi-city itinerary.</p>
            </div>

            <div class="booking-widget">
                <div class="itinerary-list" id="itinerary-list">
                    <!-- Dynamic Items -->
                </div>
                
                <div class="add-flight-placeholder" onclick="focusSearch()">
                    <i class="fas fa-plus-circle"></i> Click map or search to add destination
                </div>

                <div class="route-actions" id="route-actions" style="display: none;">
                    <button class="btn-text" onclick="clearItinerary()">Clear Route</button>
                </div>
            </div>

            <div id="flight-card" class="flight-card">
                <div class="card-header">
                    <span>TRIP SUMMARY</span>
                    <i class="fas fa-plane"></i>
                </div>
                <div class="card-body">
                    <div class="stat-grid">
                        <div class="stat-item">
                            <span class="stat-label">Total Distance</span>
                            <span class="stat-value" id="card-distance">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Est. Duration</span>
                            <span class="stat-value" id="card-time">-</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Aircraft</span>
                        <span class="stat-value" id="card-aircraft">Boeing 777-300ER</span>
                    </div>
                    <div class="amenities" style="margin-top: 10px;">
                        <span class="amenity-badge">First</span>
                        <span class="amenity-badge">Business</span>
                        <span class="amenity-badge">Economy</span>
                    </div>
                </div>
            </div>

            <div class="destinations-wrapper">
                <div class="search-container" style="position: relative;">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="search-input" class="search-input" placeholder="Search city or airport code..." onkeyup="filterDestinations()">
                </div>
                <div class="list-scroll-area">
                    <div class="list-header">
                        <span>AVAILABLE DESTINATIONS</span>
                        <span id="dest-count">0</span>
                    </div>
                    <div id="dest-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>
    <script>
        /* --- Data: Extended Emirates Destinations --- */
        const destinations = [
             // Middle East (Hub)
             { lat: 25.2532, lng: 55.3657, name: "Dubai", code: "DXB", country: "UAE", hub: true },
            { lat: 24.4330, lng: 54.6511, name: "Abu Dhabi", code: "AUH", country: "UAE" },
            { lat: 21.6797, lng: 39.1564, name: "Jeddah", code: "JED", country: "Saudi Arabia" },
            { lat: 24.9574, lng: 46.6987, name: "Riyadh", code: "RUH", country: "Saudi Arabia" },
            { lat: 29.2267, lng: 47.9689, name: "Kuwait City", code: "KWI", country: "Kuwait" },
            { lat: 26.2708, lng: 50.6332, name: "Bahrain", code: "BAH", country: "Bahrain" },
            { lat: 23.5933, lng: 58.2844, name: "Muscat", code: "MCT", country: "Oman" },
            { lat: 33.8206, lng: 35.4883, name: "Beirut", code: "BEY", country: "Lebanon" },
            { lat: 31.7227, lng: 35.9932, name: "Amman", code: "AMM", country: "Jordan" },
            { lat: 35.6892, lng: 51.3890, name: "Tehran", code: "IKA", country: "Iran" },
            { lat: 33.2625, lng: 44.2333, name: "Baghdad", code: "BGW", country: "Iraq" },
            { lat: 30.5503, lng: 47.7478, name: "Basra", code: "BSR", country: "Iraq" },

            // Europe
            { lat: 51.4700, lng: -0.4543, name: "London Heathrow", code: "LHR", country: "UK" },
            { lat: 51.1537, lng: -0.1821, name: "London Gatwick", code: "LGW", country: "UK" },
            { lat: 51.8860, lng: 0.2389, name: "London Stansted", code: "STN", country: "UK" },
            { lat: 53.3537, lng: -2.2750, name: "Manchester", code: "MAN", country: "UK" },
            { lat: 55.8711, lng: -4.4325, name: "Glasgow", code: "GLA", country: "UK" },
            { lat: 54.9756, lng: -1.6218, name: "Newcastle", code: "NCL", country: "UK" },
            { lat: 53.4213, lng: -6.2701, name: "Dublin", code: "DUB", country: "Ireland" },
            { lat: 49.0097, lng: 2.5479, name: "Paris", code: "CDG", country: "France" },
            { lat: 43.6653, lng: 7.2150, name: "Nice", code: "NCE", country: "France" },
            { lat: 45.7256, lng: 5.0811, name: "Lyon", code: "LYS", country: "France" },
            { lat: 50.0379, lng: 8.5622, name: "Frankfurt", code: "FRA", country: "Germany" },
            { lat: 48.3538, lng: 11.7861, name: "Munich", code: "MUC", country: "Germany" },
            { lat: 51.2895, lng: 6.7668, name: "Dusseldorf", code: "DUS", country: "Germany" },
            { lat: 53.6304, lng: 9.9882, name: "Hamburg", code: "HAM", country: "Germany" },
            { lat: 47.4647, lng: 8.5492, name: "Zurich", code: "ZRH", country: "Switzerland" },
            { lat: 46.2370, lng: 6.1092, name: "Geneva", code: "GVA", country: "Switzerland" },
            { lat: 41.8003, lng: 12.2389, name: "Rome", code: "FCO", country: "Italy" },
            { lat: 45.6301, lng: 8.7231, name: "Milan", code: "MXP", country: "Italy" },
            { lat: 45.5053, lng: 12.3519, name: "Venice", code: "VCE", country: "Italy" },
            { lat: 44.5354, lng: 11.2887, name: "Bologna", code: "BLQ", country: "Italy" },
            { lat: 40.4719, lng: -3.5626, name: "Madrid", code: "MAD", country: "Spain" },
            { lat: 41.2974, lng: 2.0833, name: "Barcelona", code: "BCN", country: "Spain" },
            { lat: 38.7742, lng: -9.1342, name: "Lisbon", code: "LIS", country: "Portugal" },
            { lat: 52.3105, lng: 4.7683, name: "Amsterdam", code: "AMS", country: "Netherlands" },
            { lat: 50.9010, lng: 4.4856, name: "Brussels", code: "BRU", country: "Belgium" },
            { lat: 48.1103, lng: 16.5697, name: "Vienna", code: "VIE", country: "Austria" },
            { lat: 50.1008, lng: 14.2600, name: "Prague", code: "PRG", country: "Czechia" },
            { lat: 47.4385, lng: 19.2523, name: "Budapest", code: "BUD", country: "Hungary" },
            { lat: 52.1672, lng: 20.9679, name: "Warsaw", code: "WAW", country: "Poland" },
            { lat: 37.9364, lng: 23.9445, name: "Athens", code: "ATH", country: "Greece" },
            { lat: 41.2753, lng: 28.7519, name: "Istanbul", code: "IST", country: "Turkey" },
            { lat: 55.6180, lng: 12.6508, name: "Copenhagen", code: "CPH", country: "Denmark" },
            { lat: 59.6519, lng: 17.9186, name: "Stockholm", code: "ARN", country: "Sweden" },
            { lat: 60.1976, lng: 11.1004, name: "Oslo", code: "OSL", country: "Norway" },
            { lat: 55.4103, lng: 37.9024, name: "Moscow", code: "DME", country: "Russia" },

            // Americas (US/Canada)
            { lat: 40.6413, lng: -73.7781, name: "New York JFK", code: "JFK", country: "USA" },
            { lat: 40.6895, lng: -74.1745, name: "Newark", code: "EWR", country: "USA" },
            { lat: 42.3656, lng: -71.0096, name: "Boston", code: "BOS", country: "USA" },
            { lat: 38.9531, lng: -77.4565, name: "Washington DC", code: "IAD", country: "USA" },
            { lat: 41.9742, lng: -87.9073, name: "Chicago", code: "ORD", country: "USA" },
            { lat: 28.4312, lng: -81.3081, name: "Orlando", code: "MCO", country: "USA" },
            { lat: 25.7959, lng: -80.2870, name: "Miami", code: "MIA", country: "USA" },
            { lat: 32.8998, lng: -97.0403, name: "Dallas", code: "DFW", country: "USA" },
            { lat: 29.9902, lng: -95.3368, name: "Houston", code: "IAH", country: "USA" },
            { lat: 47.4502, lng: -122.3088, name: "Seattle", code: "SEA", country: "USA" },
            { lat: 37.6213, lng: -122.3790, name: "San Francisco", code: "SFO", country: "USA" },
            { lat: 33.9425, lng: -118.4081, name: "Los Angeles", code: "LAX", country: "USA" },
            { lat: 43.6777, lng: -79.6248, name: "Toronto", code: "YYZ", country: "Canada" },
            { lat: 45.4706, lng: -73.7407, name: "Montreal", code: "YUL", country: "Canada" },

            // South America
            { lat: -23.4356, lng: -46.4731, name: "São Paulo", code: "GRU", country: "Brazil" },
            { lat: -22.8089, lng: -43.2436, name: "Rio de Janeiro", code: "GIG", country: "Brazil" },
            { lat: -34.8222, lng: -58.5358, name: "Buenos Aires", code: "EZE", country: "Argentina" },
            { lat: 4.7016, lng: -74.1469, name: "Bogota", code: "BOG", country: "Colombia" },
            { lat: 19.4363, lng: -99.0721, name: "Mexico City", code: "MEX", country: "Mexico" },

            // Asia
            { lat: 35.7720, lng: 140.3929, name: "Tokyo Narita", code: "NRT", country: "Japan" },
            { lat: 35.5494, lng: 139.7798, name: "Tokyo Haneda", code: "HND", country: "Japan" },
            { lat: 34.4320, lng: 135.2296, name: "Osaka", code: "KIX", country: "Japan" },
            { lat: 37.4602, lng: 126.4407, name: "Seoul", code: "ICN", country: "South Korea" },
            { lat: 40.0799, lng: 116.6031, name: "Beijing", code: "PEK", country: "China" },
            { lat: 31.1443, lng: 121.8083, name: "Shanghai", code: "PVG", country: "China" },
            { lat: 23.3924, lng: 113.2988, name: "Guangzhou", code: "CAN", country: "China" },
            { lat: 22.3080, lng: 113.9185, name: "Hong Kong", code: "HKG", country: "China" },
            { lat: 25.0797, lng: 121.2342, name: "Taipei", code: "TPE", country: "Taiwan" },
            { lat: 14.5086, lng: 121.0194, name: "Manila", code: "MNL", country: "Philippines" },
            { lat: 15.1858, lng: 120.5597, name: "Clark", code: "CRK", country: "Philippines" },
            { lat: 10.3075, lng: 123.9794, name: "Cebu", code: "CEB", country: "Philippines" },
            { lat: 13.6900, lng: 100.7501, name: "Bangkok", code: "BKK", country: "Thailand" },
            { lat: 8.1132, lng: 98.3169, name: "Phuket", code: "HKT", country: "Thailand" },
            { lat: 1.3644, lng: 103.9915, name: "Singapore", code: "SIN", country: "Singapore" },
            { lat: 2.7456, lng: 101.7099, name: "Kuala Lumpur", code: "KUL", country: "Malaysia" },
            { lat: -6.1275, lng: 106.6537, name: "Jakarta", code: "CGK", country: "Indonesia" },
            { lat: -8.7482, lng: 115.1672, name: "Bali", code: "DPS", country: "Indonesia" },
            { lat: 10.8188, lng: 106.6519, name: "Ho Chi Minh City", code: "SGN", country: "Vietnam" },
            { lat: 21.2187, lng: 105.8055, name: "Hanoi", code: "HAN", country: "Vietnam" },

            // South Asia
            { lat: 19.0896, lng: 72.8656, name: "Mumbai", code: "BOM", country: "India" },
            { lat: 28.5665, lng: 77.1031, name: "Delhi", code: "DEL", country: "India" },
            { lat: 12.9941, lng: 80.1709, name: "Chennai", code: "MAA", country: "India" },
            { lat: 13.1979, lng: 77.7068, name: "Bengaluru", code: "BLR", country: "India" },
            { lat: 17.2403, lng: 78.4294, name: "Hyderabad", code: "HYD", country: "India" },
            { lat: 10.1518, lng: 76.3930, name: "Kochi", code: "COK", country: "India" },
            { lat: 23.0732, lng: 72.6347, name: "Ahmedabad", code: "AMD", country: "India" },
            { lat: 22.6547, lng: 88.4467, name: "Kolkata", code: "CCU", country: "India" },
            { lat: 24.9065, lng: 67.1608, name: "Karachi", code: "KHI", country: "Pakistan" },
            { lat: 31.5204, lng: 74.4036, name: "Lahore", code: "LHE", country: "Pakistan" },
            { lat: 33.5492, lng: 73.0992, name: "Islamabad", code: "ISB", country: "Pakistan" },
            { lat: 23.8433, lng: 90.3978, name: "Dhaka", code: "DAC", country: "Bangladesh" },
            { lat: 7.1807, lng: 79.8842, name: "Colombo", code: "CMB", country: "Sri Lanka" },
            { lat: 4.1928, lng: 73.5291, name: "Malé", code: "MLE", country: "Maldives" },

            // Africa
            { lat: 30.1219, lng: 31.4056, name: "Cairo", code: "CAI", country: "Egypt" },
            { lat: -26.1367, lng: 28.2411, name: "Johannesburg", code: "JNB", country: "South Africa" },
            { lat: -33.9715, lng: 18.6021, name: "Cape Town", code: "CPT", country: "South Africa" },
            { lat: -29.6144, lng: 31.1197, name: "Durban", code: "DUR", country: "South Africa" },
            { lat: -1.3192, lng: 36.9278, name: "Nairobi", code: "NBO", country: "Kenya" },
            { lat: 8.9806, lng: 38.7995, name: "Addis Ababa", code: "ADD", country: "Ethiopia" },
            { lat: 33.3676, lng: -7.5898, name: "Casablanca", code: "CMN", country: "Morocco" },
            { lat: 36.6910, lng: 3.2155, name: "Algiers", code: "ALG", country: "Algeria" },
            { lat: 36.8510, lng: 10.2272, name: "Tunis", code: "TUN", country: "Tunisia" },
            { lat: 6.5774, lng: 3.3213, name: "Lagos", code: "LOS", country: "Nigeria" },
            { lat: 9.0068, lng: 7.2631, name: "Abuja", code: "ABV", country: "Nigeria" },
            { lat: 5.6052, lng: -0.1667, name: "Accra", code: "ACC", country: "Ghana" },
            { lat: 14.7397, lng: -17.4902, name: "Dakar", code: "DSS", country: "Senegal" },
            { lat: -6.8781, lng: 39.2026, name: "Dar es Salaam", code: "DAR", country: "Tanzania" },
            { lat: 0.0425, lng: 32.4435, name: "Entebbe", code: "EBB", country: "Uganda" },
            { lat: -20.4302, lng: 57.6836, name: "Mauritius", code: "MRU", country: "Mauritius" },
            { lat: -4.6740, lng: 55.5215, name: "Seychelles", code: "SEZ", country: "Seychelles" },

            // Oceania
            { lat: -33.9461, lng: 151.1772, name: "Sydney", code: "SYD", country: "Australia" },
            { lat: -37.6690, lng: 144.8410, name: "Melbourne", code: "MEL", country: "Australia" },
            { lat: -27.3942, lng: 153.1218, name: "Brisbane", code: "BNE", country: "Australia" },
            { lat: -31.9403, lng: 115.9672, name: "Perth", code: "PER", country: "Australia" },
            { lat: -34.9462, lng: 138.5332, name: "Adelaide", code: "ADL", country: "Australia" },
            { lat: -37.0082, lng: 174.7850, name: "Auckland", code: "AKL", country: "New Zealand" },
            { lat: -43.4864, lng: 172.5369, name: "Christchurch", code: "CHC", country: "New Zealand" }
        ];

        /* --- State & Init --- */
        let map;
        let markers = {};
        let clusterGroup;
        let selectedMarkersLayer; // Separate layer for selected markers so they don't cluster
        let itinerary = []; // Array of destination objects
        let routePolylines = [];

        function initMap() {
            // Centered on Middle East/World
            map = L.map('map', {
                center: [25, 15], 
                zoom: 3,
                zoomControl: false,
                minZoom: 2,
                maxBounds: [[-90, -180], [90, 180]]
            });

            L.control.zoom({ position: 'bottomright' }).addTo(map);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap, © CartoDB',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // Configure Cluster Group for UNSELECTED markers
            clusterGroup = L.markerClusterGroup({
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                maxClusterRadius: 50,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'medium';
                    if (count > 20) size = 'large';
                    
                    return L.divIcon({
                        html: `<div>${count}</div>`,
                        className: `ek-cluster ek-cluster-${size}`,
                        iconSize: L.point(40, 40)
                    });
                }
            });

            selectedMarkersLayer = L.layerGroup().addTo(map);

            // Set default itinerary (DXB)
            itinerary.push(destinations[0]); // Dubai
            refreshMapState();
            renderItineraryUI();
            renderDestList();
        }

        /* --- Map Logic --- */
        
        // This function completely redraws markers based on state
        // Key Fix: Selected markers go into 'selectedMarkersLayer' (no cluster), others go into 'clusterGroup'
        function refreshMapState() {
            clusterGroup.clearLayers();
            selectedMarkersLayer.clearLayers();
            markers = {};

            const itineraryCodes = itinerary.map(d => d.code);

            destinations.forEach((dest) => {
                const isSelected = itineraryCodes.includes(dest.code);
                const isHub = dest.hub === true;
                const indexInItinerary = itineraryCodes.indexOf(dest.code);

                // Determine Icon Style
                let icon;
                if (isSelected) {
                    // It's in the route
                    let typeClass = 'stop';
                    if (indexInItinerary === 0) typeClass = 'origin';
                    else if (indexInItinerary === itinerary.length - 1 && itinerary.length > 1) typeClass = 'dest';
                    
                    icon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div class="marker-selected ${typeClass}">${indexInItinerary + 1}</div>`,
                        iconSize: [18, 18],
                        iconAnchor: [9, 9]
                    });
                } else {
                    // Standard marker
                    icon = L.divIcon({
                        className: 'custom-marker',
                        html: isHub ? `<div class="marker-hub"><i class="fas fa-star"></i></div>` : `<div class="marker-pin"></div>`,
                        iconSize: isHub ? [20, 20] : [14, 14],
                        iconAnchor: isHub ? [10, 10] : [7, 7]
                    });
                }

                const marker = L.marker([dest.lat, dest.lng], { icon: icon });
                
                marker.bindTooltip(`${dest.name} (${dest.code})`, {
                    direction: 'top',
                    className: 'ek-tooltip',
                    offset: [0, -10]
                });

                marker.on('click', () => handleMarkerClick(dest));
                markers[dest.code] = marker;

                // PLACEMENT LOGIC
                if (isSelected) {
                    // Add directly to map (Bypasses clustering)
                    selectedMarkersLayer.addLayer(marker);
                } else {
                    if (isHub) {
                        // Hubs also visible directly (optional, but good for context)
                        // But let's cluster them if not selected to reduce clutter at world zoom
                        marker.addTo(map).setZIndexOffset(500); // Add directly but lower z than selected
                    } else {
                        clusterGroup.addLayer(marker);
                    }
                }
            });

            map.addLayer(clusterGroup);
            drawRoute();
        }

        function handleMarkerClick(dest) {
            // Check if already in itinerary
            const existingIndex = itinerary.findIndex(d => d.code === dest.code);
            
            if (existingIndex !== -1) {
                // Remove if clicked again (toggle)? Or just alert?
                // Let's allow removing by clicking again for simplicity
                if (existingIndex === itinerary.length -1 && itinerary.length > 1) {
                   removeFromItinerary(existingIndex);
                   return;
                }
            } else {
                addToItinerary(dest);
            }
        }

        function addToItinerary(dest) {
            itinerary.push(dest);
            refreshMapState();
            renderItineraryUI();
        }

        function removeFromItinerary(index) {
            itinerary.splice(index, 1);
            refreshMapState();
            renderItineraryUI();
        }

        function clearItinerary() {
            itinerary = [destinations[0]]; // Reset to DXB
            refreshMapState();
            renderItineraryUI();
            document.getElementById('flight-card').style.display = 'none';
        }

        function drawRoute() {
            // Clear old lines
            routePolylines.forEach(l => map.removeLayer(l));
            routePolylines = [];

            if (itinerary.length < 2) return;

            let totalDist = 0;
            let bounds = [];

            // Draw segments
            for (let i = 0; i < itinerary.length - 1; i++) {
                const start = itinerary[i];
                const end = itinerary[i+1];
                
                const latlngs = [
                    [start.lat, start.lng],
                    [end.lat, end.lng]
                ];

                const polyline = L.polyline(latlngs, {
                    color: 'var(--ek-red)',
                    weight: 3,
                    opacity: 0.9,
                    dashArray: '5, 5',
                    lineCap: 'round'
                }).addTo(map);
                
                routePolylines.push(polyline);
                
                totalDist += getDistanceFromLatLonInKm(start.lat, start.lng, end.lat, end.lng);
                bounds.push([start.lat, start.lng]);
                bounds.push([end.lat, end.lng]);
            }

            // Fit bounds to show entire route
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 6 });
            }

            updateFlightCard(totalDist);
        }

        /* --- UI Logic --- */
        
        function renderItineraryUI() {
            const container = document.getElementById('itinerary-list');
            container.innerHTML = '';

            itinerary.forEach((dest, index) => {
                const el = document.createElement('div');
                el.className = 'itinerary-segment';
                if (index === itinerary.length - 1) el.classList.add('active');

                let dotClass = 'stop';
                if (index === 0) dotClass = 'origin';
                else if (index === itinerary.length - 1) dotClass = 'dest';

                el.innerHTML = `
                    <div class="dashed-connector"></div>
                    <div class="segment-dot ${dotClass}"></div>
                    <div class="segment-content">
                        <span class="segment-code">${dest.code}</span>
                        ${dest.name}
                    </div>
                    ${index > 0 ? `<div class="segment-remove" onclick="removeFromItinerary(${index})"><i class="fas fa-times"></i></div>` : ''}
                `;
                container.appendChild(el);
            });

            document.getElementById('route-actions').style.display = itinerary.length > 1 ? 'flex' : 'none';
        }

        function renderDestList() {
            filterDestinations(); // Use filter function to render
        }

        function filterDestinations() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const list = document.getElementById('dest-list');
            list.innerHTML = '';
            
            const filtered = destinations.filter(d => 
                d.name.toLowerCase().includes(query) || 
                d.code.toLowerCase().includes(query) ||
                d.country.toLowerCase().includes(query)
            );

            // Sort logic: Selected items first, then alphabetical
            filtered.sort((a, b) => {
                const aInItinerary = itinerary.some(i => i.code === a.code);
                const bInItinerary = itinerary.some(i => i.code === b.code);
                if (aInItinerary && !bInItinerary) return -1;
                if (!aInItinerary && bInItinerary) return 1;
                return a.country.localeCompare(b.country) || a.name.localeCompare(b.name);
            });

            filtered.forEach(dest => {
                const inItinerary = itinerary.some(i => i.code === dest.code);
                
                const el = document.createElement('div');
                el.className = `destination-item ${inItinerary ? 'selected' : ''}`;
                el.innerHTML = `
                    <div class="destination-code">${dest.code}</div>
                    <div class="destination-details">
                        <div class="destination-name">${dest.name}</div>
                        <div class="destination-country">${dest.country}</div>
                    </div>
                    ${inItinerary ? '<i class="fas fa-check" style="color:var(--ek-gold)"></i>' : '<i class="fas fa-plus" style="color:#ddd; font-size: 10px;"></i>'}
                `;
                el.onclick = () => {
                     // If searching, clear search after click for better UX? No, keep it.
                     handleMarkerClick(dest);
                };
                list.appendChild(el);
            });
            
            document.getElementById('dest-count').innerText = filtered.length;
        }

        function updateFlightCard(dist) {
            const time = calculateFlightTime(dist);
            
            // Logic for Aircraft type based on total distance or legs
            // Simplified: Long haul = A380
            let aircraft = "Boeing 777-300ER";
            if (dist > 5000) aircraft = "Airbus A380-800";

            document.getElementById('card-distance').innerText = Math.round(dist).toLocaleString() + " km";
            document.getElementById('card-time').innerText = time;
            document.getElementById('card-aircraft').innerText = aircraft;

            document.getElementById('flight-card').style.display = 'block';
        }

        function focusSearch() {
            document.getElementById('search-input').focus();
        }

// Calculate distance between two lat/lng points in kilometers
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); // Fixed typo here
            return R * c;
        }

    
        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }


        function calculateFlightTime(dist) {
            const speed = 850; 
            const totalHours = (dist / speed) + (0.5 * (itinerary.length - 1)); // Add 30 mins per leg
            const h = Math.floor(totalHours);
            const m = Math.round((totalHours - h) * 60);
            return `${h}h ${m}m`;
        }

        // Start
        window.onload = initMap;

    </script>
</body>
</html>
